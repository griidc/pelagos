#/bin/sh

args=("$@")

case ${args[0]} in
DRUPALGRIIDC)
    echo 'Setting Encore PublicPath to special pelagos-symfony path for drupal-coexistence'
    export publicpath="/pelagos-symfony/build"
    ;;
*)
    echo 'Setting Encore PublicPath to /build'
    export publicpath="/build"
    ;;
esac

# Stop MessageMQ
bin/console messenger:stop-workers

# Clear composer cache
composer clear-cache

# Clear symfony cache
bin/console cache:clear

# Forcefully clear the cache
sleep 2
rm -rf var/cache

# Run composer install to make sure all non-dev dependencies are installed and parameters are defined
composer install --no-dev --optimize-autoloader

# Handle Yarn
yarn install
yarn run encore prod

# Dump ENV into compiled format
composer dump-env prod

# Warn of any pending migrations, but don't apply them.
bin/console doctrine:migrations:status

# Rebuild elasticsearch indexes
bin/console fos:elastica:reset
bin/console fos:elastica:populate

# Prime the gml2geojson cache for production, test, demo, and dev (prod mode)
HOSTNAME=$(hostname)
if [ "$HOSTNAME" == "griidc-prod.tamucc.edu" ]; then
    echo "Priming the gml2geojson cache on production"
    wget -O /dev/null -q https://data.griidc.org/api/datasetsgeojson
elif [ "$HOSTNAME" == "griidc-test.tamucc.edu" ]; then
    echo "Priming the gml2geojson cache on test"
    wget -O /dev/null -q https://data-test.griidc.org/api/datasetsgeojson
elif [ "$HOSTNAME" == "griidc-demo.tamucc.edu" ]; then
    echo "Priming the gml2geojson cache on demo"
    wget -O /dev/null -q https://demo.griidc.org/api/datasetsgeojson
elif [ "$HOSTNAME" == "griidc-dev.tamucc.edu" ]; then
    echo "Priming the gml2geojson cache on dev's prod mode"
    wget -O /dev/null -q https://griidc-dev.tamucc.edu/api/datasetsgeojson
fi

echo "Remember to start consumers with: sudo systemctl start pelagos-messengemq"
