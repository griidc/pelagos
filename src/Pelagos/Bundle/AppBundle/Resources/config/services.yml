services:
    pelagos.entity.handler:
        class: Pelagos\Bundle\AppBundle\Handler\EntityHandler
        arguments: ["@doctrine.orm.entity_manager", "@security.token_storage", "@security.authorization_checker", "@pelagos.event.entity_event_dispatcher"]

    pelagos.twig.extensions:
        class: Pelagos\Bundle\AppBundle\Twig\Extensions
        arguments: ["%kernel.root_dir%"]
        public: false
        tags:
            - { name: twig.extension }

    pelagos.twig_entity_extensions:
        class: Pelagos\TwigEntityExtensions
        public: false
        tags:
            - { name: twig.extension }

    pelagos.form.type.person:
        class: Pelagos\Bundle\AppBundle\Form\PersonType
        arguments: ["@router"]
        tags:
            - { name: form.type }

    pelagos.dif.listener:
        class: Pelagos\Event\DIFListener
        arguments: ["@twig", "@mailer", "@security.token_storage", "%mailer_from_addr%", "%mailer_from_name%", "@pelagos.entity.handler", "@old_sound_rabbit_mq.doi_issue_producer"]
        tags:
            - { name: kernel.event_listener, event: pelagos.entity.dif.saved_not_submitted, method: onSavedNotSubmitted }
            - { name: kernel.event_listener, event: pelagos.entity.dif.submitted, method: onSubmitted }
            - { name: kernel.event_listener, event: pelagos.entity.dif.approved, method: onApproved }
            - { name: kernel.event_listener, event: pelagos.entity.dif.unlock_requested, method: onUnlockRequested }
            - { name: kernel.event_listener, event: pelagos.entity.dif.unlocked, method: onUnlocked }

    pelagos.datasetsubmission.listener:
        class: Pelagos\Event\DatasetSubmissionListener
        arguments: ["@twig", "@mailer", "@security.token_storage", "%mailer_from_addr%", "%mailer_from_name%", "@pelagos.entity.handler", "@old_sound_rabbit_mq.doi_issue_producer", "@pelagos.util.data_store", "@pelagos.util.mdapplogger"]
        tags:
            - { name: kernel.event_listener, event: pelagos.entity.dataset_submission.submitted, method: onSubmitted }
            - { name: kernel.event_listener, event: pelagos.entity.dataset_submission.resubmitted, method: onResubmitted }
            - { name: kernel.event_listener, event: pelagos.entity.dataset_submission.dataset_processed, method: onDatasetProcessed }
            - { name: kernel.event_listener, event: pelagos.entity.dataset_submission.html_found, method: onHtmlFound }
            - { name: kernel.event_listener, event: pelagos.entity.dataset_submission.dataset_unprocessable, method: onDatasetUnprocessable }
            - { name: kernel.event_listener, event: pelagos.entity.dataset_submission.approved, method: onApproved }

    pelagos.logactionitem.listener:
        class: Pelagos\Event\LogActionItemEventListener
        arguments: ["@doctrine.orm.entity_manager"]
        tags:
            - { name: kernel.event_listener, event: pelagos.logactionitem.file_download, method: onNewLogCreated }
            - { name: kernel.event_listener, event: pelagos.logactionitem.search_terms_log, method: onNewLogCreated }
            - { name: kernel.event_listener, event: pelagos.logactionitem.restrictions_log, method: onNewLogCreated }

    pelagos.account.listener:
        class: Pelagos\Event\AccountListener
        arguments: ["@twig", "@mailer", "@security.token_storage", "%mailer_from_addr%", "%mailer_from_name%", "@pelagos.entity.handler"]
        tags:
            - { name: kernel.event_listener, event: pelagos.entity.account.created, method: onCreated }

    pelagos.doctrine.dataset.listener:
        class: Pelagos\Event\DoctrineDatasetListener
        tags:
            - { name: doctrine.event_listener, event: onFlush }

    pelagos.form.type.dif:
        class: Pelagos\Bundle\AppBundle\Form\DIFType
        arguments: ["@doctrine.orm.entity_manager", "@security.authorization_checker", "@security.token_storage"]
        tags:
            - { name: form.type }

    pelagos.rabbit.consumer.dataset_submission.filer:
        class: Pelagos\Bundle\AppBundle\Rabbit\Consumer\DatasetSubmissionConsumer
        arguments: ["@doctrine.orm.entity_manager", "@pelagos.util.data_store", "@logger", "@pelagos.event.entity_event_dispatcher", "@pelagos.util.mdapplogger", "@old_sound_rabbit_mq.dataset_file_hasher_producer"]
        tags:
            - { name: monolog.logger, channel: filer }

    pelagos.rabbit.consumer.dataset_submission.retriever:
        class: Pelagos\Bundle\AppBundle\Rabbit\Consumer\DatasetSubmissionConsumer
        arguments: ["@doctrine.orm.entity_manager", "@pelagos.util.data_store", "@logger", "@pelagos.event.entity_event_dispatcher", "@pelagos.util.mdapplogger", "@old_sound_rabbit_mq.dataset_file_hasher_producer"]
        tags:
            - { name: monolog.logger, channel: retriever }

    pelagos.rabbit.consumer.create_homedir:
        class: Pelagos\Bundle\AppBundle\Rabbit\Consumer\CreateHomedirConsumer
        arguments: ["@doctrine.orm.entity_manager", "@logger"]
        tags:
            - { name: monolog.logger, channel: create_homedir }

    pelagos.rabbit.consumer.dataset_file_hasher:
        class: Pelagos\Bundle\AppBundle\Rabbit\Consumer\DatasetFileHasherConsumer
        arguments: ["@doctrine.orm.entity_manager", "@pelagos.util.data_store", "@logger"]
        tags:
            - { name: monolog.logger, channel: dataset_file_hasher }

    pelagos.rabbit.consumer.doi_issue:
        class: Pelagos\Bundle\AppBundle\Rabbit\Consumer\DoiConsumer
        arguments: ["@doctrine.orm.entity_manager", "@logger", "@pelagos.event.entity_event_dispatcher"]
        tags:
            - { name: monolog.logger, channel: doi_issue }

    pelagos.handler.upload:
        class: Pelagos\Bundle\AppBundle\Handler\UploadHandler
        arguments: ["%homedir_prefix%"]
